<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GPS Point / Poly Submit</title>
    <style>
        body {
            font-family: monospace;
            font-size: 20px;
        }

        .container {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
        }

        .box {
            border: 4px solid #222;
            padding: 20px;
            width: 100%;
            height: 800px;
        }

        ul {
            padding-left: 18px;
            max-height: 300px;
            overflow-y: auto;
        }

        button {
            margin-top: 10px;
            border: 0px;
            border-radius: 50px;
            width: 100%;
            height: 40%;
            font-size: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LEFT: POLY -->
        <div class="box">
            <h3>Polygon</h3>
    
            <button type="button" onclick="addPointtoPoly()">Add current GPS point to polygon</button>
    
            <button type="button" onclick="addPoly()">Add polygon</button>
        </div>
    
        <!-- RIGHT: POINT -->
        <div class="box">
            <h3>Point</h3>
    
            <button type="button" onclick="addPoint()">Add current GPS point</button>
        </div>
    </div>
    <div class="container">
        <!-- Bottom Submit and Name -->
        <div class="box">
            <h3>Submit</h3>
            <label for="Gname" style="font-size: 40px;">Group Name: </label>
            <input id="GName" type="text" height=20px style="font-size: 40px; height: 10%; width: 60%; border: 2px solid #222; margin-bottom: 20px;">
            <button type="button" onclick="downloadData()">Download Data</button>
        </div>
    </div>
    <script>
        var polyPoints = [];

        var data = {
            "type" : "FeatureCollection",
            "features" : [
            ]
        }; 
    
        function getCurrentPosition(callback)
        {
            if (!("geolocation" in navigator)) {
                alert("Geolocation not supported");
                return;
            }

            const options = {
                enableHighAccuracy: true, // improves compatibility
                timeout: 10000,            // prevents silent hang
                maximumAge: 300000         // allow cached result (5 min)
            };

            function success(pos) {
                callback([
                    pos.coords.latitude,
                    pos.coords.longitude
                ]);
            }

            function error(err) {
                alert("GPS error (" + err.code + "): " + err.message);
            }

            // Optional permission pre-check
            if (navigator.permissions) {
                navigator.permissions.query({ name: "geolocation" })
                .then(result => {

                    if (result.state === "denied") {
                        alert("Location permission denied");
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(success, error, options);

                })
                .catch(() => {
                    navigator.geolocation.getCurrentPosition(success, error, options);
                });
            }
            else {
                navigator.geolocation.getCurrentPosition(success, error, options);
            }
        }
    
        function addPointtoPoly() {
            getCurrentPosition(pos => {
                polyPoints.push([pos.lat, pos.lon]);
            });
        }
    
        function addPoint() {
            getCurrentPosition(pos => 
                data.features.push({
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [pos.lat, pos.lon]
                    },
                    "properties": { }
                })   
            );     
        }
    
        function addPoly() {
            if (polyPoints.length < 2) {
                alert("Need at least 2 polyPoints for a poly");
                return;
            }
            
            console.log(JSON.stringify(polyPoints));
            data.features.push({
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [JSON.stringify(polyPoints)]
                    },
                    "properties": { }
            })   
    
            polyPoints = [];
    
        }
        function downloadData() 
        {
            var GName = document.getElementById("GName").value;

            if (GName === "") {
                alert("Must Enter a group name to download");
                return;
            }

            var blob = new Blob(
                [JSON.stringify(data, null, 2)],
                { type: "application/json" }
            );

            var url = URL.createObjectURL(blob);

            var a = document.createElement("a");
            a.href = url;
            a.download = "Survey data for " + GName + ".json";

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            console.log(JSON.stringify(data));

            data = {
                "type": "FeatureCollection",
                "features": []
            };
        }
    </script>
</body>
</html>
